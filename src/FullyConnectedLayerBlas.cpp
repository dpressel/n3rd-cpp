//
// Created by Daniel on 9/24/2015.
//
#include <cblas.h>
#include "n3rd/FullyConnectedLayerBlas.h"

using namespace n3rd;
using namespace sgdtk;
//#ifdef DEBUG
const std::vector<double> RND = {0.674651437,
                    0.044378003,
                    0.12199693,
                    0.508253307,
                    0.670580756,
                    0.774941045,
                    0.913836835,
                    0.189216008,
                    0.827076989,
                    0.595743356,
                    0.348894088,
                    0.784474605,
                    0.187326731,
                    0.749438503,
                    0.187320528,
                    0.490350689,
                    0.771416541,
                    0.996510817,
                    0.901859621,
                    0.891878756,
                    0.77558243,
                    0.852984732,
                    0.544363812,
                    0.964844751,
                    0.158771726,
                    0.621036426,
                    0.889237948,
                    0.205693465,
                    0.084115908,
                    0.730618015,
                    0.180718502,
                    0.764677535,
                    0.892815904,
                    0.249571521,
                    0.316481833,
                    0.24987663,
                    0.867928777,
                    0.236657611,
                    0.255187399,
                    0.474741307,
                    0.757456796,
                    0.990951771,
                    0.595728736,
                    0.463394439,
                    0.639677868,
                    0.687472488,
                    0.8814852,
                    0.870692158,
                    0.992106265,
                    0.030846095,
                    0.942051421,
                    0.661477919,
                    0.542537684,
                    0.675839897,
                    0.17886586,
                    0.648482724,
                    0.247689109,
                    0.445377051,
                    0.352786543,
                    0.691984736,
                    0.897731228,
                    0.223287205,
                    0.052490176,
                    0.891760588,
                    0.566640965,
                    0.172961891,
                    0.65419083,
                    0.328993794,
                    0.892690612,
                    0.504505818,
                    0.195851765,
                    0.333958712,
                    0.982815474,
                    0.636689171,
                    0.289581338,
                    0.729382152,
                    0.204252308,
                    0.9425292,
                    0.103981525,
                    0.028729458,
                    0.958316658,
                    0.208526816,
                    0.470377218,
                    0.218323509,
                    0.030481417,
                    0.767037458,
                    0.256244935,
                    0.093695533,
                    0.337321939,
                    0.830041965,
                    0.800982456,
                    0.279640435,
                    0.263913397,
                    0.416782456,
                    0.085280155,
                    0.958809543,
                    0.779679803,
                    0.731471115,
                    0.560031132,
                    0.254851178,
                    0.958807502,
                    0.95087803,
                    0.736504214,
                    0.696950072,
                    0.351348372,
                    0.975590731,
                    0.637885024,
                    0.345374038,
                    0.046884662,
                    0.304538189,
                    0.98483618,
                    0.955029868,
                    0.764474526,
                    0.898139066,
                    0.841255572,
                    0.001276727,
                    0.424305774,
                    0.697547751,
                    0.220434773,
                    0.240087919,
                    0.3265487,
                    0.670516006,
                    0.401820905,
                    0.608469447,
                    0.860867809,
                    0.857237714,
                    0.409149125,
                    0.041746948,
                    0.121751296,
                    0.886764372,
                    0.902540397,
                    0.307141687,
                    0.377642466,
                    0.641201406,
                    0.015314548,
                    0.204067471,
                    0.933467422,
                    0.503228586,
                    0.342606227,
                    0.607832886,
                    0.955982594,
                    0.793138812,
                    0.025262844,
                    0.034962254,
                    0.529481536,
                    0.318772765,
                    0.483051509,
                    0.636138602,
                    0.457876397,
                    0.114610538,
                    0.025700229,
                    0.574831751,
                    0.571132398,
                    0.015881134,
                    0.860251215,
                    0.996557586,
                    0.033529371,
                    0.601228042,
                    0.464801074,
                    0.46752681,
                    0.430861486,
                    0.458594287,
                    0.688347441,
                    0.159914341,
                    0.570633032,
                    0.452981529,
                    0.132338316,
                    0.145162692,
                    0.792216135,
                    0.980075726,
                    0.361110834,
                    0.253122967,
                    0.769102839,
                    0.240669878,
                    0.829940699,
                    0.888971085,
                    0.981305541,
                    0.554774612,
                    0.391150878,
                    0.77741821,
                    0.496390137,
                    0.98957995,
                    0.926957478,
                    0.613547053,
                    0.426773509,
                    0.466764701,
                    0.601755206,
                    0.186701672,
                    0.349303588,
                    0.812905377,
                    0.390208909,
                    0.247629668,
                    0.377394434,
                    0.22943948,
                    0.211285074,
                    0.88499678,
                    0.147101541,
                    0.110233969,
                    0.810120576,
                    0.053947248,
                    0.575608154,
                    0.966975345,
                    0.670843011,
                    0.963673897,
                    0.277696623,
                    0.198179365,
                    0.077724641,
                    0.850285235,
                    0.211471002,
                    0.851747548,
                    0.150283443,
                    0.268983506,
                    0.975667394,
                    0.989679258,
                    0.478777869,
                    0.369366859,
                    0.069264787,
                    0.533668146,
                    0.139200178,
                    0.59352537,
                    0.438965561,
                    0.67765819,
                    0.269793501,
                    0.92525341,
                    0.16883136,
                    0.070727827,
                    0.480168989,
                    0.077449056,
                    0.580690823,
                    0.663284422,
                    0.395463855,
                    0.126084959,
                    0.528906838,
                    0.210516197,
                    0.575058876,
                    0.974982278,
                    0.189444775,
                    0.188680365,
                    0.726334465,
                    0.243068832,
                    0.292353479,
                    0.582131409,
                    0.488482323,
                    0.252360068,
                    0.108745723,
                    0.336686777,
                    0.634159004,
                    0.530429069,
                    0.143588675,
                    0.217080432,
                    0.095502087,
                    0.68662419,
                    0.047852702,
                    0.414004011,
                    0.916919819,
                    0.139136382,
                    0.479369871,
                    0.021922182,
                    0.018196075,
                    0.272206418,
                    0.430778274,
                    0.439292829,
                    0.382143776,
                    0.493978176,
                    0.64765428,
                    0.536596058,
                    0.379651976,
                    0.016065208,
                    0.297911044,
                    0.738417551,
                    0.111219342,
                    0.131047932,
                    0.309056872,
                    0.92845644,
                    0.689407403,
                    0.345422031,
                    0.564658693,
                    0.414396474,
                    0.543810622,
                    0.555735681,
                    0.085373588,
                    0.487562292,
                    0.586272184,
                    0.382534335,
                    0.268848201,
                    0.690641065,
                    0.070671609,
                    0.072703381,
                    0.66506941,
                    0.050010968,
                    0.788503777,
                    0.869438603,
                    0.827731139,
                    0.344162292,
                    0.185480811,
                    0.007680794,
                    0.211860333,
                    0.816100842,
                    0.202484313,
                    0.208284905 };
//#endif

sgdtk::Tensor& FullyConnectedLayerBlas::forward(const sgdtk::Tensor& input)
{

    output.constant(0.);
    std::copy(input.d.begin(), input.d.end(), z.d.begin());
    cblas_dgemv(CblasColMajor, CblasNoTrans, outputLength, inputLength, 1.0, &weights.d[0], outputLength, &input.d[0], 1, 1.0, &output.d[0], 1);
    return output;

}

FullyConnectedLayerBlas::FullyConnectedLayerBlas(int outputLength, int inputLength)
{

    this->outputLength = outputLength;
    this->inputLength = inputLength;
    weights.resize({outputLength, this->inputLength});
    gradsW.resize({outputLength, this->inputLength});
    grads.resize({this->inputLength});
    output.resize({outputLength});
    z.resize({inputLength});
    biases.resize(outputLength);
    biasGrads.resize(outputLength);

    std::default_random_engine generator;
    std::uniform_real_distribution<double> distribution(0.0, 1.0);
    double stdv = 1. / std::sqrt(inputLength);
    double stdv2 = stdv * 2;

    for (int i = 0, ibase = 0; i < outputLength; ++i, ibase += this->inputLength)
    {
        double number;
        double d;

        for (int j = 0; j < this->inputLength; ++j)
        {
//#ifdef DEBUG
///            number = RND[Current++ % RND.size()];
//#else
            number = distribution(generator);
//#endif
            d = number * stdv2 - stdv;

            weights[ibase + j] = d;
        }
        number = distribution(generator);
        d = number * stdv2 - stdv;
        biases[i] = 0;//d;
    }


}



sgdtk::Tensor& FullyConnectedLayerBlas::backward(const sgdtk::Tensor& chainGrad, double y)
{

    grads.constant(0.);

    cblas_dgemv(CblasColMajor, CblasTrans, outputLength, inputLength, 1.0, &weights.d[0], outputLength,
                &chainGrad.d[0], 1, 1.0, &grads.d[0], 1);
    cblas_dger(CblasColMajor, outputLength, inputLength, 1.0, &chainGrad.d[0], 1, &z.d[0], 1, &gradsW.d[0], outputLength);

    for (int i = 0; i < outputLength; ++i)
    {
        biasGrads[i] = chainGrad.d[i];
    }
    return grads;


}
